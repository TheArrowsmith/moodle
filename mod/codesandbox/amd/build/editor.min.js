define(["jquery","core/ajax","core/notification","core/str"],function(d,u,l,e){return{init:function(t,o,s,e,n){var r=null,a=n||"python",i={python:"python",ruby:"ruby",elixir:"erlang"},c={python:"# Welcome to Python Code Sandbox!\n# Write your code below:\n\n",ruby:"# Welcome to Ruby Code Sandbox!\n# Write your code below:\n\n",elixir:"# Welcome to Elixir Code Sandbox!\n# Write your code below:\n\n"};d(document).ready(function(){var e=document.getElementById("code-editor");e&&(!(e=(r=CodeMirror.fromTextArea(e,{mode:i[a],theme:"monokai",lineNumbers:!0,indentUnit:4,lineWrapping:!0,autofocus:!0})).getValue().trim())&&o?r.setValue(o):e||r.setValue(c[a])),d("#language-select").on("change",function(){var e=d(this).val();if(e!==a){a=e,r.setOption("mode",i[a]);var t,o=r.getValue().trim(),s=!1;for(t in c)if(o===c[t].trim()){s=!0;break}o&&!s||r.setValue(c[a])}})}),d("#run-code").on("click",function(){var e;r&&(e=r.getValue(),d("#loading-spinner").show(),d("#run-code").prop("disabled",!0),d(".output-section").text(""),d.ajax({url:s+"/execute",method:"POST",contentType:"application/json",data:JSON.stringify({code:e,language:a}),success:function(e){d("#stdout").text(e.stdout||"(no output)"),d("#stderr").text(e.stderr||"(no errors)"),(e.stderr?d('a[href="#stderr-tab"]'):d('a[href="#stdout-tab"]')).tab("show")},error:function(e,t,o){var s="Error: ";e.responseJSON&&e.responseJSON.detail?s+=e.responseJSON.detail:s+=o||t||"Could not connect to execution service",l.alert("Execution Error",s)},complete:function(){d("#loading-spinner").hide(),d("#run-code").prop("disabled",!1)}}))}),d("#submit-code").on("click",function(){var e;r&&(e=r.getValue(),d("#loading-spinner").show(),d("#submit-code").prop("disabled",!0),u.call([{methodname:"mod_codesandbox_submit_code",args:{cmid:t,code:e,language:a}}])[0].done(function(e){var t,o,s,n,r;e.success?(l.addNotification({message:"Code submitted successfully!",type:"success"}),e.results&&(t=e.results,(r=d("#test-results")).empty(),void 0!==t.score&&(o=(100*t.score).toFixed(1),s=.8<=t.score?"text-success":.6<=t.score?"text-warning":"text-danger",r.append('<div class="mb-3"><h4>Score: <span class="'+s+'">'+o+"%</span></h4><p>Tests passed: "+t.passed_tests+" / "+t.total_tests+"</p></div>")),t.results&&0<t.results.length&&(n=d('<div class="test-result-list"></div>'),t.results.forEach(function(e){var t,o=e.passed?"fa-check text-success":"fa-times text-danger",o=d('<div class="test-result-item mb-2"><i class="fa '+o+'"></i> <strong>'+e.test_name+"</strong></div>");!e.passed&&e.message&&o.append('<pre class="test-error-message">'+(e=e.message,t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"},e.replace(/[&<>"']/g,function(e){return t[e]}))+"</pre>"),n.append(o)}),r.append(n)),d('a[href="#results-tab"]').tab("show"))):l.alert("Submission Error",e.error||"Failed to submit code")}).fail(function(e){l.exception(e)}).always(function(){d("#loading-spinner").hide(),d("#submit-code").prop("disabled",!1)}))}),d("#clear-output").on("click",function(){d(".output-section").text(""),d("#test-results").empty()})}}});